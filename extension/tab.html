<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="pure-min.css"/>
    <style>
  #container {
    margin:20px auto;
    width: 95%;
    max-width: 960px;
  }
  h2 { color: #111; }
  h3, p { color: #333; }
  a {
    text-decoration: none;
  }
  .link {
    color: #555;
    text-decoration: underline;
  }
  .grey {
    color: #aaa;
  }
    </style>
  </head>
<body>
<div id='container'></div>
<script id='template' type='text/ractive'>
<div class="pure-g">
<div class="pure-u-1-2">
<h2>BlobMarks</h2>
</div>

<div class="pure-u-1-2">
<form class="pure-form" style="margin-top:10px;float:right;" on-submit="submit">
    <input type="text" value="{{q}}">
    <button type="submit" class="pure-button">Search</button>
    <a href="#" class="pure-button" on-click="clear">Clear</a>
</form>
</div>
</div>

<div>
{{^bookmarks}}
<p style="margin:20px 0;font-size:1.1em;">No bookmarks :(</p>
{{/bookmarks}}
{{#bookmarks}}
<div style="margin:20px 0 40px 0;">
<a style="display:block" href="#" on-click="open-bookmark:{{this}}">
<h3 style="padding:0;margin:0 0 5px 0;">{{title}}</h3>
<p style="padding:0;margin:0 0 10px 0;" class="grey">{{ idTs(_id) }}</p>
{{#selectedText}}<p class="grey" style="padding:0;margin:0 0 10px 0;">{{selectedText}}</p>{{/selectedText}}
<p style="padding:0;margin:0;" class="link">{{url}}</p>
</a>
</div>
{{/bookmarks}}
</div>

</script>
<script src="ractive.js"></script>
<script src="base.js"></script>
<script>
var ractive = new BaseRactive({
  // The `el` option can be a node, an ID, or a CSS selector.
  el: '#container',

  // We could pass in a string, but for the sake of convenience
  // we're passing the ID of the <script> tag above.
  template: '#template',
  loadBookmarks: function() {
    console.log('loadBookmarks');
    var that = this;
fetch(that.url(), {
      mode: 'cors',
      method: 'get',
      headers: that.headers(),
    }).then(status)
      .then(json)
      .then(function(data) {
        console.log('bookmarks', data);
        that.set('bookmarks', data);
    });

  },
  search: function(q) {
    var that = this;
    fetch(that.url('/search?q='+q), {
      mode: 'cors',
      method: 'get',
      headers: that.headers(),
    }).then(status)
      .then(json)
      .then(function(data) {
        console.log('bookmarks', data);
        that.set('bookmarks', data);
    });


  },
  oninit: function() {
    var that = this;
    this.loadConfig(function() {
      that.loadBookmarks();
    });
    this.on('open-bookmark', function(event, bookmark) {
      event.original.preventDefault();
      chrome.tabs.create({
        "url": bookmark.url,
      });
    });
    this.on('submit', function(event) {
      event.original.preventDefault();
      that.search(this.get('q'));
    });
      this.on('clear', function(event) {
      event.original.preventDefault();
      that.loadBookmarks();
      this.set('q', '');
    });

  },
  data: {
    q: '',
    idTs: function(_id) {
      return new Date(parseInt(_id.substring(0, 8), 16) * 1000);
    },
    config: { done: false }, bookmarked: false,
  },
});
</script>
</body>
</html>
